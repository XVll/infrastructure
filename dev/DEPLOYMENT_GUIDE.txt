=============================================================================
DEV VM DEPLOYMENT - Quick Reference Commands
=============================================================================

STEP 1: CREATE VM (Proxmox Host)
---------------------------------
qm clone <TEMPLATE_ID> 114 --name dev-vm --full
qm set 114 --ipconfig0 ip=10.10.10.114/24,gw=10.10.10.1
qm set 114 --virtfs0 /flash/docker/homelab/dev,mp=docker-vm
qm start 114

# SSH to VM
ssh user@10.10.10.114
sudo hostnamectl set-hostname dev-vm
sudo mount -a
echo 'export OP_SERVICE_ACCOUNT_TOKEN="<token>"' >> ~/.bashrc
source ~/.bashrc


STEP 2: CREATE 1PASSWORD SECRETS (Local Machine)
-------------------------------------------------
# Generate secrets
openssl rand -base64 50   # For secret_key
openssl rand -hex 105     # For internal_token

# Create items
op item create --category=password --title="gitea-db" --vault=Server \
  password=$(openssl rand -base64 32)

op item create --category=password --title="gitea" --vault=Server \
  secret_key=$(openssl rand -base64 50) \
  internal_token=$(openssl rand -hex 105) \
  runner_token="placeholder"


STEP 3: CREATE POSTGRESQL DATABASE (DB VM 10.10.10.111)
--------------------------------------------------------
ssh user@10.10.10.111
docker exec -it postgres psql -U postgres

# In PostgreSQL:
CREATE DATABASE gitea;
CREATE USER gitea WITH PASSWORD '<from-1password>';
GRANT ALL PRIVILEGES ON DATABASE gitea TO gitea;
\q


STEP 4: UPDATE .ENV (Dev VM)
-----------------------------
cd /opt/homelab
nano .env
# Change: DOMAIN=yourdomain.com


STEP 5: DEPLOY GITEA (Dev VM)
------------------------------
cd /opt/homelab
docker compose pull gitea
op run --env-file=.env -- docker compose up -d gitea
docker compose logs -f gitea

# Access: http://10.10.10.114:3000
# Complete wizard, create admin account


STEP 6: CONFIGURE RUNNER (Dev VM)
----------------------------------
# In Gitea UI: Site Admin → Actions → Runners → Create new Runner
# Copy registration token

# Update 1Password (local machine):
op item edit gitea --vault=Server runner_token="<token>"

# Deploy runner (dev VM):
op run --env-file=.env -- docker compose up -d act-runner
docker compose logs -f act-runner


STEP 7: TEST CONTAINER REGISTRY (Dev VM)
-----------------------------------------
# Generate token in Gitea: Settings → Applications → Generate Token
# Scope: package:write

docker login git.yourdomain.com
docker pull hello-world
docker tag hello-world git.yourdomain.com/admin/test:latest
docker push git.yourdomain.com/admin/test:latest


STEP 8: INSTALL DOKPLOY (Dev VM)
---------------------------------
curl -sSL https://dokploy.com/install.sh | sh
# Access: http://10.10.10.114:3200

=============================================================================
See dev/README.md for detailed instructions and troubleshooting
=============================================================================
