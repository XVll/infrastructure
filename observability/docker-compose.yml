
# OBSERVABILITY HOST: Komodo + Monitoring Stack
# Build services one at a time in this order:
# 1. Komodo (container management - requires MongoDB from data host)
# 2. Prometheus (metrics storage)
# 3. Grafana (visualization)
# 4. Loki (log aggregation - requires MinIO from data host)
# 5. Alloy (metrics/logs collector)

services:
  # ============================================================================
  # 1. PORTAINER - Container Management UI
  # ============================================================================
  # Deploy FIRST - no dependencies
  # Access: https://10.10.10.112:9443

  portainer:
    image: portainer/portainer-ce:latest
    container_name: portainer
    restart: unless-stopped
    ports:
      - "10.10.10.112:9443:9443"  # HTTPS Web UI
      - "10.10.10.112:8000:8000"  # Edge agent tunnel
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./portainer/data:/data
    networks:
      - obs_net
    healthcheck:
      test: ["CMD", "wget", "--tries=1", "--spider", "--no-check-certificate", "https://localhost:9443"]
      interval: 30s
      timeout: 10s
      retries: 3
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================================================
  # 2. PROMETHEUS - Metrics Storage
  # ============================================================================
  # Deploy second - no dependencies
  # Access: http://10.10.10.112:9090 or https://prometheus.onurx.com

  prometheus:
    image: prom/prometheus:v3.1.0  # Latest stable version (2025)
    container_name: prometheus
    restart: unless-stopped
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=90d'  # 90 days retention
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
      - '--web.enable-remote-write-receiver'  # Enable remote write (for Alloy)
      - '--web.enable-lifecycle'  # Enable reload via API
    ports:
      - "10.10.10.112:9090:9090"
    volumes:
      - ./prometheus/config/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./prometheus/config/rules:/etc/prometheus/rules:ro
      - ./prometheus/data:/prometheus
    networks:
      - obs_net
    healthcheck:
      test: ["CMD", "wget", "--tries=1", "--spider", "http://localhost:9090/-/healthy"]
      interval: 30s
      timeout: 10s
      retries: 3
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================================================
  # 3. GRAFANA - Visualization & Dashboards
  # ============================================================================
  # Deploy third - connects to Prometheus
  # Access: http://10.10.10.112:3000 or https://grafana.onurx.com

  grafana:
    image: grafana/grafana:11.4.0  # Latest stable version (2025)
    container_name: grafana
    restart: unless-stopped
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_ADMIN_USER}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD}
      - GF_SERVER_ROOT_URL=https://grafana.onurx.com
      - GF_INSTALL_PLUGINS=grafana-clock-panel,grafana-piechart-panel
      - GF_AUTH_ANONYMOUS_ENABLED=false
      - GF_ANALYTICS_REPORTING_ENABLED=false
      - GF_ANALYTICS_CHECK_FOR_UPDATES=true
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_LOG_MODE=console
      - GF_LOG_LEVEL=info
    ports:
      - "10.10.10.112:3000:3000"
    volumes:
      - ./grafana/data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning:ro
      - ./grafana/dashboards:/var/lib/grafana/dashboards:ro
    networks:
      - obs_net
    depends_on:
      - prometheus
      - loki
    healthcheck:
      test: ["CMD", "wget", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================================================
  # 4. LOKI - Log Aggregation
  # ============================================================================
  # Deploy fourth - stores logs locally (can use MinIO later for long-term storage)
  # Access: http://10.10.10.112:3100

  loki:
    image: grafana/loki:3.3.2  # Latest stable version (2025)
    container_name: loki
    restart: unless-stopped
    command: -config.file=/etc/loki/config.yml
    ports:
      - "10.10.10.112:3100:3100"
    volumes:
      - ./loki/config/config.yml:/etc/loki/config.yml:ro
      - ./loki/data:/loki
    networks:
      - obs_net
    healthcheck:
      test: ["CMD", "wget", "--tries=1", "--spider", "http://localhost:3100/ready"]
      interval: 30s
      timeout: 10s
      retries: 3
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================================================
  # 5. ALLOY - Metrics & Logs Collector
  # ============================================================================
  # Deploy fifth - collects metrics + logs, sends to Prometheus + Loki
  # Web UI: http://10.10.10.112:12345

  alloy:
    image: grafana/alloy:v1.11.2  # Latest stable version (2025)
    container_name: alloy
    restart: unless-stopped
    privileged: true  # Required for system metrics collection
    command:
      - run
      - /etc/alloy/config.alloy
      - --server.http.listen-addr=0.0.0.0:12345
      - --storage.path=/var/lib/alloy/data
    ports:
      - "10.10.10.112:12345:12345"  # Alloy web UI
      # OTLP ports (uncomment when enabling OpenTelemetry receiver in config.alloy)
      # - "10.10.10.112:4317:4317"    # OTLP gRPC (for app instrumentation)
      # - "10.10.10.112:4318:4318"    # OTLP HTTP (for app instrumentation)
    volumes:
      - ./alloy/config/config.alloy:/etc/alloy/config.alloy:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro  # Docker metrics + logs
      - /:/host/root:ro  # System metrics (CPU, disk, etc.)
      - /sys:/host/sys:ro  # System metrics
      - /proc:/host/proc:ro  # System metrics
      - /var/log:/var/log:ro  # System logs (syslog, auth.log)
      - ./alloy/data:/var/lib/alloy/data  # Alloy state
    networks:
      - obs_net
    depends_on:
      - prometheus
      - loki
    environment:
      - HOSTNAME=observability-vm
    # No health check - Alloy doesn't have wget/curl installed
    # Service is working if container is running and port 12345 is open
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================================================
  # 6. BESZEL HUB - Server Monitoring Dashboard
  # ============================================================================
  # Deploy sixth - central monitoring hub for all VMs
  # Web UI: http://10.10.10.112:8090 or https://beszel.onurx.com
  # Create admin account on first access

  beszel:
    image: henrygd/beszel:latest
    container_name: beszel
    restart: unless-stopped
    ports:
      - "10.10.10.112:8090:8090"
    volumes:
      - ./beszel/data:/beszel_data
      - ./beszel/socket:/beszel_socket  # Unix socket for local agent
    networks:
      - obs_net
    healthcheck:
      test: ["CMD", "wget", "--tries=1", "--spider", "http://localhost:8090"]
      interval: 30s
      timeout: 10s
      retries: 3
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================================================
  # 7. BESZEL AGENT - Local System Monitor (observability VM)
  # ============================================================================
  # Monitors observability VM itself via Unix socket
  # Configure after deploying Hub (copy connection details from Hub web UI)

  beszel-agent:
    image: henrygd/beszel-agent:latest
    container_name: beszel-agent
    restart: unless-stopped
    network_mode: host  # Required for network interface stats
    volumes:
      - ./beszel/agent_data:/var/lib/beszel-agent  # Agent persistent data
      - ./beszel/socket:/beszel_socket  # Unix socket connection to Hub
      - /var/run/docker.sock:/var/run/docker.sock:ro  # Docker container stats
    environment:
      # These will be provided by Hub web UI after adding system
      # Update these values after deploying Hub
      LISTEN: /beszel_socket/beszel.sock
      HUB_URL: http://localhost:8090
      # KEY: "paste_public_key_from_hub_here"
      # TOKEN: "paste_token_from_hub_here"
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  obs_net:
    driver: bridge

volumes:
  portainer_data:
  # prometheus_data:
  # grafana_data:
  # loki_data:
